#!/usr/bin/env bash
set -euo pipefail

# Configuration
VM_DIR="$HOME/vms/guix"
# Use ftpmirror.gnu.org for automatic mirror selection (faster than ftp.gnu.org)
# 1.4.0 ISO is not compressed on the mirror
ISO_URL="https://ftpmirror.gnu.org/gnu/guix/guix-system-install-1.4.0.x86_64-linux.iso"
ISO_FILE="$VM_DIR/guix-install.iso"
DISK_FILE="$VM_DIR/guix.qcow2"
DISK_SIZE="50G"
MEMORY="4G"
CORES="4"

# Dependency check
for cmd in qemu-system-x86_64 qemu-img; do
    if ! command -v "$cmd" &> /dev/null; then
        echo "Error: '$cmd' is not installed."
        echo "Please install it (e.g., via 'qemu')."
        exit 1
    fi
done

# Setup
mkdir -p "$VM_DIR"

if [ ! -f "$ISO_FILE" ]; then
    echo "Downloading Guix System ISO..."
    echo "URL: $ISO_URL"
    # Create temp file to avoid partial downloads being seen as complete
    TMP_ISO="${ISO_FILE}.tmp"
    if command -v curl &> /dev/null; then
        curl -L -C - -o "$TMP_ISO" "$ISO_URL"
    elif command -v wget &> /dev/null; then
        wget --no-config -c -O "$TMP_ISO" "$ISO_URL"
    else
        echo "Error: Neither curl nor wget found. Please install one."
        exit 1
    fi
    mv "$TMP_ISO" "$ISO_FILE"
fi

if [ ! -f "$ISO_FILE" ]; then
    echo "Error: Failed to download ISO to $ISO_FILE"
    exit 1
fi

if [ ! -f "$DISK_FILE" ]; then
    echo "Creating $DISK_SIZE disk image..."
    qemu-img create -f qcow2 "$DISK_FILE" "$DISK_SIZE"
fi

# Run
echo "Starting Guix VM..."
echo "  Memory: $MEMORY"
echo "  Cores:  $CORES"
echo "  Disk:   $DISK_FILE"
echo "  ISO:    $ISO_FILE"
echo ""

# Boot order logic:
# If disk is new/empty, QEMU enters boot menu or boots CDROM if HDD fails.
# Providing -boot menu=on allows user to choose F12.

exec qemu-system-x86_64 \
    -enable-kvm \
    -m "$MEMORY" \
    -smp "$CORES" \
    -drive file="$DISK_FILE",format=qcow2,if=virtio \
    -cdrom "$ISO_FILE" \
    -boot menu=on \
    -nic user,model=virtio-net-pci \
    -vga virtio \
    -display gtk,gl=on \
    "$@"
