#!/usr/bin/env bash
# swu: download specific wallpaper from unsplash
# Usage:
#   swu [options]
# Options:
#   -q, --query STR             search terms (e.g. "nature,water")
#   -o, --orientation STR       landscape|portrait|squarish (default: landscape)
#   -l, --location DIR          download directory (default: $XDG_PICTURES_DIR/wl or ~/pic/wl)
#   -k, --apikey KEY            Unsplash Access Key (optional if set via UNSPLASH_ACCESS_KEY)
#   -f, --featured              limit to featured photos
#   -r, --resolution WxH        deprecated in API, but kept for compat (ignored)
#   -h, --help                  show this help

IFS=$'\n\t'

if [[ "$1" == "-h" || "$1" == "--help" || "$1" == "help" ]]; then
  sed -n '2,11p' "$0" | sed 's/^# \{0,1\}//'; exit 0
fi

die(){ printf 'swu: %s\n' "$*" >&2; :; }
need(){ command -v "$1" >/dev/null 2>&1 || printf 'swu: missing dependency: %s\n' "$1" >&2; }
need curl
need jq

location="${XDG_PICTURES_DIR:-$HOME/pic}/wl"
query=""
orientation="landscape"
apikey="${UNSPLASH_ACCESS_KEY:-}"
featured=""

# Translate long options to short
_args=()
while (($#)); do
  case "$1" in
    --help) _args+=("-h"); shift ;;
    --query) _args+=("-q" "$2"); shift 2 ;;
    --orientation) _args+=("-o" "$2"); shift 2 ;;
    --location) _args+=("-l" "$2"); shift 2 ;;
    --apikey) _args+=("-k" "$2"); shift 2 ;;
    --featured) _args+=("-f"); shift ;;
    --resolution) shift 2 ;; # Ignored
    --*) die "unknown option: $1" ;;
    *) _args+=("$1"); shift ;;
  esac
done
set -- "${_args[@]}"

while getopts ":q:o:l:k:fh" opt; do
  case "$opt" in
    q) query="$OPTARG" ;;
    o) orientation="$OPTARG" ;;
    l) location="$OPTARG" ;;
    k) apikey="$OPTARG" ;;
    f) featured="true" ;;
    h) sed -n '2,11p' "$0" | sed 's/^# \{0,1\}//'; exit 0 ;;
    :) die "option -$OPTARG requires an argument" ;;
    \?) die "unknown option: -$OPTARG" ;;
  esac
done
shift $((OPTIND-1))

if [[ -z "$apikey" ]]; then
    die "Unsplash Access Key is required. Set UNSPLASH_ACCESS_KEY or use --apikey."
fi

# Build API URL
# Endpoint: https://api.unsplash.com/photos/random
api_url="https://api.unsplash.com/photos/random?client_id=$apikey&count=1"

[[ -n "$query" ]] && api_url+="&query=$(jq -nr --arg v "$query" '$v|@uri')"
[[ -n "$orientation" ]] && api_url+="&orientation=$orientation"
[[ -n "$featured" ]] && api_url+="&featured=true"

# Request
# Ensure we don't dump secrets if it fails
json="$(curl -fsS --retry 3 --retry-delay 1 "$api_url")" || die "failed to query API (check your key or quota)"

# Parse
# Unsplash returns an array if count > 1, but we asked for count=1 which might return array or object.
# Actually strictly speaking with count=1 it returns an array of 1 object.
# Let's handle both just in case.
img_url=$(jq -r 'if type=="array" then .[0].urls.raw else .urls.raw end' <<< "$json")
id=$(jq -r 'if type=="array" then .[0].id else .id end' <<< "$json")

if [[ "$img_url" == "null" || -z "$img_url" ]]; then
    die "no image found or bad response"
fi

# Unsplash raw urls need parameters for quality/format if desired, but raw is usually full size.
# We can append q=100 or fmt=jpg if needed. defaults are usually fine.

mkdir -p -- "$location"
wallpaper="$location/unsplash-$id.jpg"

curl -fsS --retry 3 --retry-delay 1 -o "$wallpaper" "$img_url" >/dev/null || die "failed to download image"
printf '%s\n' "$wallpaper"
