name: "Scheduled Flake Update"

on:
  schedule:
    # Run every Sunday at 03:00 UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      update_all:
        description: 'Update all inputs (vs only nixpkgs)'
        required: false
        default: 'true'
        type: boolean

jobs:
  update-flake:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        # Need write access for creating branches
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - uses: cachix/install-nix-action@v27
      with:
        nix_path: nixpkgs=channel:nixos-unstable
    
    - name: Update flake inputs
      run: |
        echo "Updating flake inputs..."
        if [ "${{ inputs.update_all }}" = "false" ]; then
          nix flake update nixpkgs
        else
          nix flake update
        fi
        
        echo ""
        echo "=== Changes ==="
        git diff flake.lock || echo "No changes"
    
    - name: Check if there are changes
      id: changes
      run: |
        if git diff --quiet flake.lock; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "No updates available"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "Updates found!"
        fi
    
    - name: Create Pull Request
      if: steps.changes.outputs.has_changes == 'true'
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "[flake] update inputs"
        title: "ðŸ”„ Flake inputs update"
        body: |
          ## Automated flake inputs update
          
          This PR was automatically created by the scheduled update workflow.
          
          **Changes:**
          ```
          $(git diff --stat flake.lock)
          ```
          
          Please review and merge if CI passes.
        branch: flake-update
        delete-branch: true
        labels: |
          dependencies
          automated
